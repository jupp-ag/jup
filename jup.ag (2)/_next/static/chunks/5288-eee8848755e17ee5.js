"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5288],{89953:function(e,t,n){n.d(t,{LT:function(){return m},Me:function(){return x}});var r=n(27195),o=n(97620),i=n(8857),a=n.n(i),c=n(7761),s=n(93981),u=n(65838),l=n(21382),d=n(6340),p=n(3011),f=n(33715),h=n(78877),g={long:{main:"#32DF7B",shade:"#32DF7BB3"},short:{main:"#EB5757",shade:"#EB5757B3"},tp:{main:"#00BCF0",shade:"#00BCF0B3"},sl:{main:"#00BCF0",shade:"#00BCF0B3"},lq:{main:"rgb(100,116,139)",shade:"rgb(100,116,139)"}},x=function(){var e=(0,u.Os)().wallet,t=(0,u.Bn)().connection,n=(0,l.tc)(),i=n.userPositions,c=n.refreshPositionInfo,g=(0,d.Z)().promptKeeperClosePositionNotification,x=(0,p.KO)(f.l.isClosingAllPositions),m=(0,o.Z)(x,2),v=m[0],b=m[1];return(0,s.useCallback)(function(){var n=(0,r.Z)(a().mark((function n(o){var s,u,l,d;return a().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(i&&0!==(null===i||void 0===i?void 0:i.length)&&!v){n.next=2;break}return n.abrupt("return");case 2:if(e){n.next=4;break}throw new Error("Wallet not connected");case 4:if(b(!0),n.prev=5,s=null===i||void 0===i?void 0:i.find((function(e){return e.publicKey.toString()===o.publicKey}))){n.next=9;break}throw new Error("Cannot find position ".concat(o.id));case 9:return n.next=11,(0,h._L)(e,t,s);case 11:if(u=n.sent){n.next=14;break}throw new Error("Cannot find market close instruction");case 14:return l=u.instructions,d=u.positionRequestKey,n.next=17,new Promise(function(){var e=(0,r.Z)(a().mark((function e(t,n){return a().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,g(l,d,(function(e){c(),t(e)}),(function(e){n(e)}));case 2:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}());case 17:return n.abrupt("return",n.sent);case 20:n.prev=20,n.t0=n.catch(5),console.log("Failed to close all positions!",n.t0);case 23:return n.prev=23,c(),b(!1),n.finish(23);case 27:case"end":return n.stop()}}),n,null,[[5,20,23,27]])})));return function(e){return n.apply(this,arguments)}}(),[t,v,g,c,b,i,e])},m=function(e){var t=e.isLoaded,n=e.widget,r=e.positions,o=(0,u.Os)().wallet,i=(0,u.Bn)().connection,a=(0,s.useRef)([]);(0,s.useEffect)((function(){n&&t?r&&r.length>0&&r.forEach((function(e){if(n&&!a.current.find((function(t){return t.id===e.id})))try{n.onChartReady((function(){var t,r=g[e.action].main,o=g[e.action].shade;"lq"===e.action?t=n.activeChart().createPositionLine():(t=n.activeChart().createOrderLine()).setCancelTooltip("Market close").onCancel(t,(function(t){e.onCloseAction&&(t.setText(c.ag._("Closing {0}...",{0:e.label})),e.onCloseAction(e).finally((function(){t.setText(e.label)})))})).setCancelButtonBackgroundColor(o).setCancelButtonBorderColor(r).setCancelButtonIconColor("#fff"),t.setPrice(e.price).setText(e.label).setQuantity("$".concat(e.sizeUsd)).setLineColor(r).setBodyBackgroundColor(o).setBodyBorderColor(r).setQuantityBorderColor(r).setQuantityBackgroundColor(o).setBodyTextColor("#fff").setQuantityTextColor("#fff"),a.current.push({id:e.id,adapter:t})}))}catch(t){console.error(t)}})):a.current=[]}),[r,a,n,t,o,i]),(0,s.useEffect)((function(){Array.isArray(r)&&0===r.length?a.current.forEach((function(e,t){e.adapter.remove(),a.current=[]})):a.current.forEach((function(e,t){if(!(null===r||void 0===r?void 0:r.find((function(t){return t.id===e.id})))&&e.adapter&&e.adapter.remove)try{e.adapter.remove()}catch(n){}finally{a.current.splice(t,1)}}))}),[r])}},6340:function(e,t,n){var r,o=n(70107),i=n(63956),a=n(27195),c=n(97620),s=n(8857),u=n.n(s),l=n(7761),d=n(96343),p=n(43231),f=n(93981),h=n(17463),g=n(65838),x=n(59394),m=n(21382),v=n(24628),b=n(57917),y=n(50992),k=n(55540),w=n(90342),P=n(3011),T=n(49839),O=n(57565),C=n(91551),A=n.n(C),S=n(18849),j=n(57281),E=n(29541),_=n(795).Buffer;function D(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function R(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?D(Object(n),!0).forEach((function(t){(0,i.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):D(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}!function(e){e.MAX_ATTEMPTS="MAX_ATTEMPTS",e.FAILED_TO_CLOSE_REQUEST="FAILED_TO_CLOSE_REQUEST",e.COLLATERAL_REFUNDED="COLLATERAL_REFUNDED"}(r||(r={}));t.Z=function(){var e=(0,m.tc)().refreshPositionInfo,t=(0,b.SR)(),n=t.addNotificationTx,r=t.updateNotificationTxStatus,i=(t.updateNotificationMetadata,(0,d.lm)()),s=i.toast,C=i.close,D=(0,g.Os)(),B=D.wallet,K=D.signTransaction,I=D.signAllTransactions,M=(0,g.Bn)().connection,Z=(0,g.C9)(),q=(0,w.gs)(),N=q.modifyComputeUnitPriceAndLimit,L=q.priorityLevel,F=(0,P.KO)(T.yz),U=(0,c.Z)(F,1)[0],H=(0,f.useMemo)((function(){return new p.Connection(M._rpcEndpoint,"confirmed")}),[M]),V=(0,f.useMemo)((function(){var e=new O.Y7(H,{},O.Y7.defaultOptions());return[e,new O.$r(k.x,m.KX,e)]}),[H]),G=(V[0],V[1]),X=(0,f.useCallback)(function(){var e=(0,a.Z)(u().mark((function e(t,n,o,i,d,f,g){var b,y,k,w,P,T,O,D,B,K,I,M,Z;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,H.getTransactions([n],{commitment:"confirmed",maxSupportedTransactionVersion:0});case 2:if(b=e.sent,y=(0,c.Z)(b,1),(k=y[0])&&k.blockTime){e.next=7;break}throw"Transaction not found";case 7:return w=function(){setTimeout((function(){C(t)}),1e4),d&&d(!0)},P=k.blockTime,T=1e3*(P+45),O=void 0,D="",B="",K=function(){var e=(0,a.Z)(u().mark((function e(t){var n,r,o,i,a,c,s;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,H.getTransactions(t,{commitment:"confirmed",maxSupportedTransactionVersion:0});case 2:if(n=e.sent,r=n.flatMap((function(e){var t,n,r=null===e||void 0===e?void 0:e.transaction.message.staticAccountKeys.findIndex((function(e){return e.equals(m.KX)}));return null===e||void 0===e||null===(t=e.meta)||void 0===t||null===(n=t.innerInstructions)||void 0===n?void 0:n.flatMap((function(t){return t.instructions.map((function(t){if(t.programIdIndex===r){var n=A().decode(t.data),o=S.base64.encode(n.subarray(8));return{event:G.coder.events.decode(o),tx:e}}}))}))})),o=r.find((function(e){var t,n;return"IncreasePositionEvent"===(null===e||void 0===e||null===(t=e.event)||void 0===t?void 0:t.name)||"DecreasePositionEvent"===(null===e||void 0===e||null===(n=e.event)||void 0===n?void 0:n.name)})),i=r.find((function(e){var t;return"ClosePositionRequestEvent"===(null===e||void 0===e||null===(t=e.event)||void 0===t?void 0:t.name)})),!o){e.next=10;break}return O=!0,D=o.tx.transaction.signatures[0],e.abrupt("return");case 10:if("undefined"!==typeof o||!i){e.next=22;break}if(O=!1,D=i.tx.transaction.signatures[0],a=i.tx.transaction.message.staticAccountKeys,c=a.findIndex((function(e){return e.equals(new p.PublicKey("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"))}))){e.next=17;break}return e.abrupt("return");case 17:if(s=i.tx.transaction.message.compiledInstructions.find((function(e){return e.programIdIndex===c}))){e.next=20;break}return e.abrupt("return");case 20:return B=_.from(s.data).toString(),e.abrupt("return");case 22:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),I=function(){var e=(0,a.Z)(u().mark((function e(){var t,r;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("undefined"!==typeof O){e.next=19;break}return e.next=3,(0,j.Dc)(5e3);case 3:if(!(Date.now()>T)){e.next=7;break}return O=!1,B="Transaction not confirmed.",e.abrupt("break",19);case 7:return e.next=9,H.getSignaturesForAddress(new p.PublicKey(o),{until:n});case 9:if(t=e.sent,0!==(r=t.filter((function(e){return null===e.err})).map((function(e){return e.signature}))).length){e.next=13;break}return e.abrupt("continue",0);case 13:if("undefined"===typeof O){e.next=15;break}return e.abrupt("return");case 15:return e.next=17,K(r);case 17:e.next=0;break;case 19:console.log("pollForEvent done");case 20:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Z=function(){var e=(0,a.Z)(u().mark((function e(){return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){M=H.onLogs(new p.PublicKey(o),function(){var t=(0,a.Z)(u().mark((function t(n){return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n.err){t.next=6;break}if("undefined"===typeof O){t.next=3;break}return t.abrupt("return");case 3:return t.next=5,K([n.signature]);case 5:e();case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}())}));case 2:console.log("listenToEvent done");case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.next=18,Promise.any([I(),Z()]).finally((function(){M&&H.removeOnLogsListener(M)}));case 18:return O?(r(t,{status:"success",stepText:"",txid:D}),s({duration:5e3,id:t,render:function(e){return(0,E.jsx)(h.x,R({customTitle:"open"===i?l.ag._("Position opened"):"partial-close"===i?l.ag._("Position reduced"):"close"===i?l.ag._("Position closed"):"increase-collateral"===i?l.ag._("Collateral increased"):void 0},e))}}),w()):(s({duration:5e3,id:t,render:function(e){var t="open"===i?l.ag._("Failed to open position"):"partial-close"===i?l.ag._("Failed to reduce position"):"close"===i?l.ag._("Failed to close position"):"increase-collateral"===i?l.ag._("Failed increase collateral"):void 0;return(0,E.jsx)(h.x,R({customTitle:t},e))}}),r(t,{txid:D,status:"fail"},{hasAdditionalPendingSteps:!1,additionalSteps:[B?(0,E.jsx)("p",{className:"ml-7 flex items-center space-x-1",children:(0,E.jsx)("span",{children:B})},"additionalSteps-error"):null,"open"===i||"increase-collateral"===i?D?(0,E.jsxs)("p",{className:"mt-3 ml-7 flex items-center space-x-1",children:[(0,E.jsx)("span",{children:l.ag._("Collateral refunded:")}),(0,E.jsx)(x.Z,{txid:D}),(0,E.jsx)(v.Z,{})]},"additionalSteps-1"):(0,E.jsx)("p",{className:"mt-3 ml-7 flex items-center space-x-1",children:(0,E.jsx)("span",{children:l.ag._("Transaction failed, collateral will be refunded shortly.")})},"additionalSteps-1"):null].filter(Boolean)}),f(!0),w()),e.abrupt("return",{success:O,txId:D,error:B});case 20:case"end":return e.stop()}}),e)})));return function(t,n,r,o,i,a,c){return e.apply(this,arguments)}}(),[C,H,G.coder.events,s,r]),W=(0,f.useCallback)(function(){var e=(0,a.Z)(u().mark((function e(t){var n,r,i,c,s;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,B&&I){e.next=3;break}throw new Error("Wallet not connected, or signAllTransactions not found");case 3:return e.next=5,M.getLatestBlockhash("confirmed");case 5:return n=e.sent,r=n.blockhash,i=n.lastValidBlockHeight,e.next=10,Promise.all(t.map(function(){var e=(0,a.Z)(u().mark((function e(t){var n,a;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=(n=new p.Transaction({blockhash:r,lastValidBlockHeight:i,feePayer:B.adapter.publicKey})).add.apply(n,(0,o.Z)(t)),e.next=3,N(a,{requestComputeBudgetLimit:3e5,referenceFee:U.isOutdated?null:"MEDIUM"===L?U.loAndDCA:"HIGH"===L&&U.loAndDCA?1.5*U.loAndDCA:"VERY_HIGH"===L&&U.loAndDCA?3*U.loAndDCA:void 0});case 3:return e.abrupt("return",a);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 10:return c=e.sent,e.next=13,I(c);case 13:return s=e.sent,e.abrupt("return",s.map((function(e){return{txid:(0,y.o$)(e),signedTransaction:e,blockhash:r,lastValidBlockHeight:i}})));case 17:throw e.prev=17,e.t0=e.catch(0),e.t0;case 20:case"end":return e.stop()}}),e,null,[[0,17]])})));return function(t){return e.apply(this,arguments)}}(),[M,I,B,N,L,U]),z=(0,f.useCallback)(function(){var e=(0,a.Z)(u().mark((function e(t,r,o,i){var a,d,p,f,g,v,b,w,P,T,O;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(B&&K){e.next=2;break}return e.abrupt("return");case 2:return a="",d=String(Math.floor(1e4*Math.random())),e.prev=4,e.next=7,W([t]);case 7:return p=e.sent,f=(0,c.Z)(p,1),g=f[0],v=g.signedTransaction,b=g.blockhash,w=g.lastValidBlockHeight,P=Date.now(),n(d,{status:"loading",txid:"",stepText:"Opening Position"}),s({duration:12e4,id:d,render:function(e){return(0,E.jsx)(h.x,R({customTitle:l.ag._("Requesting open position")},e))},closeOnClick:!1}),e.next=18,(0,y.ie)({signedTransaction:v,blockhash:b,connection:M,lastValidBlockHeight:w,idl:k.x,idlProgramId:m.KX,skipPreflight:!0});case 18:if(!("error"in(T=e.sent))){e.next=21;break}throw T.error;case 21:return n(d,{status:"loading",txid:"",stepText:l.ag._("Position request sent")}),e.next=24,X(d,T.txid,r.toString(),"open",o,i,P);case 24:e.next=33;break;case 26:e.prev=26,e.t0=e.catch(4),O=e.t0.message||l.ag._("There was an error trying to open your position."),console.log("handleSendTransaction error",O),i(!0),s({title:"Failed to perform transaction",description:(0,E.jsxs)("div",{children:[(0,E.jsx)("p",{children:O}),(0,E.jsx)("div",{children:a?(0,E.jsx)(x.Z,{txid:a}):null})]}),variant:"ERROR"}),C(d);case 33:case"end":return e.stop()}}),e,null,[[4,26]])})));return function(t,n,r,o){return e.apply(this,arguments)}}(),[B,K,W,n,s,M,X,C]),Q=(0,f.useCallback)(function(){var e=(0,a.Z)(u().mark((function e(t,r,o,i,a,c,d,p){var f,g,v;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,f=Date.now(),n(t,{status:"loading",txid:"",stepText:l.ag._("Closing Position...")}),s({duration:12e4,id:t,render:function(e){return(0,E.jsx)(h.x,R({customTitle:l.ag._("Requesting close position")},e))},closeOnClick:!1}),e.next=6,(0,y.ie)({signedTransaction:r,blockhash:o,connection:M,lastValidBlockHeight:i,idl:k.x,idlProgramId:m.KX,skipPreflight:!0});case 6:if(!("error"in(g=e.sent))){e.next=9;break}throw g.error;case 9:return n(t,{status:"loading",txid:"",stepText:l.ag._("Close position request sent")}),e.next=12,X(t,g.txid,a.toString(),"close",c,d,f);case 12:e.next=21;break;case 14:e.prev=14,e.t0=e.catch(0),v=e.t0.message||l.ag._("There was an error trying to close your position."),console.error(e.t0),d(!0),s({title:"Failed to perform transaction",description:(0,E.jsxs)("div",{children:[(0,E.jsx)("p",{children:v}),(0,E.jsx)("div",{children:p?(0,E.jsx)(x.Z,{txid:p}):null})]}),variant:"ERROR"}),C(t);case 21:case"end":return e.stop()}}),e,null,[[0,14]])})));return function(t,n,r,o,i,a,c,s){return e.apply(this,arguments)}}(),[n,C,M,X,s]),Y=(0,f.useCallback)(function(){var e=(0,a.Z)(u().mark((function e(t,n,r,o){var i,a,d,p,f,h,g,x,m;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i=String(Math.floor(1e4*Math.random())),e.next=4,W([t]);case 4:if(a=e.sent,d=(0,c.Z)(a,1),p=d[0]){e.next=9;break}throw new Error("Failed to craft transaction");case 9:return f=p.txid,h=p.signedTransaction,g=p.blockhash,x=p.lastValidBlockHeight,e.next=12,Q(i,h,g,x,n,r,o,f);case 12:e.next=20;break;case 14:e.prev=14,e.t0=e.catch(0),m=e.t0.message||l.ag._("There was an error trying to close your position."),console.error(e.t0),o(!0),s({title:"Failed to perform transaction",description:(0,E.jsx)("div",{children:(0,E.jsx)("p",{children:m})}),variant:"ERROR"});case 20:case"end":return e.stop()}}),e,null,[[0,14]])})));return function(t,n,r,o){return e.apply(this,arguments)}}(),[W,Q,s]),$=(0,f.useCallback)(function(){var e=(0,a.Z)(u().mark((function e(t){var n,r,o;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.map((function(e){return e.instructions})),e.next=3,W(n);case 3:if(r=e.sent,t.length===r.length){e.next=6;break}throw new Error("Failed to craft transaction");case 6:return e.next=8,Promise.allSettled(r.map((function(e,n){return new Promise(function(){var r=(0,a.Z)(u().mark((function r(o,i){var a,c,s,l,d,p;return u().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=String(Math.floor(1e4*Math.random())),c=e.txid,s=e.signedTransaction,l=e.blockhash,d=e.lastValidBlockHeight,p=t[n].positionRequestKey,r.abrupt("return",Q(a,s,l,d,p,o,i,c));case 4:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}())})));case 8:return o=e.sent,e.abrupt("return",o);case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),[W,Q]),J=(0,f.useCallback)(function(){var e=(0,a.Z)(u().mark((function e(t,o,i,a){var d,p,f,g,v,b,w,P,T,O,A;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(B&&K){e.next=2;break}return e.abrupt("return");case 2:return d="",p=String(Math.floor(1e4*Math.random())),e.prev=4,e.next=7,W([t]);case 7:return f=e.sent,g=(0,c.Z)(f,1),v=g[0],b=v.signedTransaction,w=v.blockhash,P=v.lastValidBlockHeight,T=Date.now(),n(p,{status:"loading",txid:"",stepText:"Reducing Position"},{customTitle:l.ag._("Reducing position...")}),s({duration:12e4,id:p,render:function(e){return(0,E.jsx)(h.x,R({customTitle:l.ag._("Requesting reduce position")},e))},closeOnClick:!1}),e.next=18,(0,y.ie)({signedTransaction:b,blockhash:w,connection:M,lastValidBlockHeight:P,idl:k.x,idlProgramId:m.KX,skipPreflight:!0});case 18:if(O=e.sent,r(p,{status:"loading",stepText:l.ag._("Position request sent")}),!("error"in O)){e.next=22;break}throw O.error;case 22:return e.next=24,X(p,O.txid,o.toString(),"partial-close",i,a,T);case 24:e.next=33;break;case 26:e.prev=26,e.t0=e.catch(4),A=e.t0.message||l.ag._("There was an error trying to close your position."),console.error(e.t0),a(!0),s({title:"Failed to perform transaction",description:(0,E.jsxs)("div",{children:[(0,E.jsx)("p",{children:A}),(0,E.jsx)("div",{children:d?(0,E.jsx)(x.Z,{txid:d}):null})]}),variant:"ERROR"}),C(p);case 33:case"end":return e.stop()}}),e,null,[[4,26]])})));return function(t,n,r,o){return e.apply(this,arguments)}}(),[B,K,W,n,s,M,X,C,r]),ee=(0,f.useCallback)(function(){var e=(0,a.Z)(u().mark((function e(t,r,o,i){var a,d,p,f,g,v,b,w,P,T,O;return u().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(B&&K){e.next=2;break}return e.abrupt("return");case 2:return a="",d=String(Math.floor(1e4*Math.random())),e.prev=4,p=Date.now(),e.next=8,W([t]);case 8:return f=e.sent,g=(0,c.Z)(f,1),v=g[0],b=v.signedTransaction,w=v.blockhash,P=v.lastValidBlockHeight,n(d,{status:"loading",txid:"",stepText:"Increasing Collateral"},{customTitle:l.ag._("Increasing collateral...")}),s({duration:12e4,id:d,render:function(e){return(0,E.jsx)(h.x,R({customTitle:l.ag._("Requesting to increase collateral"),className:"w-[95vw] lg:w-[420px]"},e))},closeOnClick:!1}),e.next=18,(0,y.ie)({signedTransaction:b,blockhash:w,connection:M,lastValidBlockHeight:P,idl:k.x,idlProgramId:m.KX,skipPreflight:!0});case 18:if(!("error"in(T=e.sent))){e.next=21;break}throw T.error;case 21:return e.next=23,X(d,T.txid,r.toString(),"increase-collateral",o,i,p);case 23:e.next=31;break;case 25:e.prev=25,e.t0=e.catch(4),O=e.t0.message||l.ag._("There was an error trying to increase your collateral."),i(!0),s({title:"Failed to perform transaction",description:(0,E.jsxs)("div",{children:[(0,E.jsx)("p",{children:O}),(0,E.jsx)("div",{children:a?(0,E.jsx)(x.Z,{txid:a}):null})]}),variant:"ERROR"}),C(d);case 31:case"end":return e.stop()}}),e,null,[[4,25]])})));return function(t,n,r,o){return e.apply(this,arguments)}}(),[B,K,W,n,s,M,X,C]),te=(0,f.useCallback)(function(){var t=(0,a.Z)(u().mark((function t(o,i,a,d){var p,f,g,v,b,w,P,T,O,A;return u().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(B&&K){t.next=2;break}return t.abrupt("return");case 2:return p="",f=String(Math.floor(1e4*Math.random())),t.prev=4,t.next=7,W([o]);case 7:return g=t.sent,v=(0,c.Z)(g,1),b=v[0],w=b.signedTransaction,P=b.blockhash,T=b.lastValidBlockHeight,n(f,{status:"loading",txid:"",stepText:"Creating TPSL"},{customTitle:d}),s({duration:12e4,id:f,render:function(e){return(0,E.jsx)(h.x,R({customTitle:l.ag._("Creating TPSL")},e))},closeOnClick:!1}),t.next=17,(0,y.ie)({signedTransaction:w,blockhash:P,connection:M,lastValidBlockHeight:T,idl:k.x,idlProgramId:m.KX,skipPreflight:!0});case 17:if(!("error"in(O=t.sent))){t.next=20;break}throw O.error;case 20:r(f,{status:"success"}),i(!0),t.next=31;break;case 24:t.prev=24,t.t0=t.catch(4),A=t.t0.message||l.ag._("There was an error trying to create your TP or SL."),console.error(t.t0),r(f,{status:"fail"}),a(!0),s({title:"Failed to perform transaction",description:(0,E.jsxs)("div",{children:[(0,E.jsx)("p",{children:A}),(0,E.jsx)("div",{children:p?(0,E.jsx)(x.Z,{txid:p}):null})]}),variant:"ERROR"});case 31:return t.prev=31,setTimeout((function(){e(),Z()}),2e3),setTimeout((function(){C(f)}),1e4),t.finish(31);case 35:case"end":return t.stop()}}),t,null,[[4,24,31,35]])})));return function(e,n,r,o){return t.apply(this,arguments)}}(),[B,K,W,n,s,M,r,e,Z,C]);return{promptKeeperOpenPositionNotification:z,promptKeeperClosePositionNotification:Y,promptKeeperCloseAllPositionNotification:$,promptKeeperPartialClosePositionNotification:J,promptKeeperIncreaseCollateralNotification:ee,promptKeeperCreateTPSLNotification:te}}},78877:function(e,t,n){n.d(t,{Zn:function(){return v},_L:function(){return y},e9:function(){return w}});var r=n(63956),o=n(97620),i=n(27195),a=n(8857),c=n.n(a),s=n(57565),u=n(43231),l=n(8770),d=n(67982),p=n(21382),f=n(13170),h=n(50992),g=n(795).Buffer;function x(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function m(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?x(Object(n),!0).forEach((function(t){(0,r.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):x(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function v(e){return b.apply(this,arguments)}function b(){return b=(0,i.Z)(c().mark((function e(t){var n,r,a,f,x,m,v,b,y,k,w,P,T,O,C,A,S,j;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.wallet,r=t.connection,a=t.positionAccount,f=t.desiredMint,x=t.tpPrice,m=t.slPrice,v=n.adapter.publicKey){e.next=4;break}throw new Error("Wallet not connected");case 4:return b=[],y=[],k=(0,l.h)(n,r),e.next=9,(0,h.c1)(f,v,r);case 9:return w=e.sent,P=(0,o.Z)(w,2),T=P[0],(O=P[1])&&b.push(O),e.next=16,Promise.all([x,m].map(function(){var e=(0,i.Z)(c().mark((function e(t){var n,r,o,i;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:return n=new s.BN(Math.floor(1e9*Math.random())),r=u.PublicKey.findProgramAddressSync([g.from("position_request"),a.publicKey.toBuffer(),n.toArrayLike(g,"le",8),[2]],k.programId)[0],o=u.PublicKey.findProgramAddressSync([r.toBuffer(),d.TOKEN_PROGRAM_ID.toBuffer(),f.toBuffer()],d.ASSOCIATED_TOKEN_PROGRAM_ID)[0],e.next=7,k.methods.createDecreasePositionRequest({entirePosition:!0,triggerPrice:t,counter:n,sizeUsdDelta:new s.BN(0),collateralUsdDelta:new s.BN(0),requestType:{trigger:{}},triggerAboveThreshold:"long"===a.side?t===x:t!==x,priceSlippage:null,jupiterMinimumOut:null}).accounts({owner:v,receivingAccount:T,perpetuals:p.TJ,pool:p.FW,position:a.publicKey,positionRequest:r,positionRequestAta:o,custody:a.custody.publicKey,custodyOracleAccount:a.custody.account.oracle.oracleAccount,collateralCustody:a.collateralCustody.publicKey,desiredMint:f,tokenProgram:d.TOKEN_PROGRAM_ID,associatedTokenProgram:d.ASSOCIATED_TOKEN_PROGRAM_ID,systemProgram:u.SystemProgram.programId,referral:null}).instruction();case 7:return i=e.sent,e.abrupt("return",i);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 16:return C=e.sent,A=(0,o.Z)(C,2),S=A[0],j=A[1],S&&y.push(S),j&&y.push(j),e.abrupt("return",{preInstructions:b,instructions:y});case 23:case"end":return e.stop()}}),e)}))),b.apply(this,arguments)}function y(e,t,n){return k.apply(this,arguments)}function k(){return(k=(0,i.Z)(c().mark((function e(t,n,r){var o,i,a,u;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",null);case 2:return o="long"===r.side?new s.BN(0):new s.BN("18446744073709551615"),e.prev=3,e.next=6,w({wallet:t,connection:n,position:r,priceSlippage:o,collateralUsdDelta:new s.BN(0),sizeUsdDelta:new s.BN(r.sizeUsd.toFixed(0)),desiredMint:r.collateralCustody.account.mint,jupiterMinimumOut:null});case 6:return i=e.sent,a=i.instructions,u=i.positionRequestKey,e.abrupt("return",{instructions:a,positionRequestKey:u});case 12:return e.prev=12,e.t0=e.catch(3),console.log("Failed to close position!",e.t0),e.abrupt("return",null);case 16:case"end":return e.stop()}}),e,null,[[3,12]])})))).apply(this,arguments)}function w(e){return P.apply(this,arguments)}function P(){return(P=(0,i.Z)(c().mark((function e(t){return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,T(m(m({},t),{},{requestType:"market",triggerPrice:null,entirePosition:null,triggerAboveThreshold:null}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function T(e){return O.apply(this,arguments)}function O(){return(O=(0,i.Z)(c().mark((function e(t){var n,r,i,a,x,m,v,b,y,k,w,P,T,O,C,A,S,j,E,_,D,R,B,K;return c().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.wallet,r=t.connection,i=t.position,a=t.collateralUsdDelta,x=t.sizeUsdDelta,m=t.desiredMint,v=t.requestType,b=t.priceSlippage,y=t.jupiterMinimumOut,k=t.triggerPrice,w=t.triggerAboveThreshold,P=t.entirePosition,T=n.adapter.publicKey){e.next=4;break}throw new Error("Wallet not connected");case 4:return O=(0,l.h)(n,r),e.next=7,(0,h.c1)(m,T,r);case 7:if(C=e.sent,A=(0,o.Z)(C,2),S=A[0],j=A[1],E=new s.BN(Math.floor(1e9*Math.random())),_=u.PublicKey.findProgramAddressSync([g.from("position_request"),i.publicKey.toBuffer(),E.toArrayLike(g,"le",8),[2]],O.programId)[0],D=u.PublicKey.findProgramAddressSync([_.toBuffer(),d.TOKEN_PROGRAM_ID.toBuffer(),m.toBuffer()],d.ASSOCIATED_TOKEN_PROGRAM_ID)[0],R=[],j&&R.push(j),B=[],m.equals(f.W4)&&B.push(d.Token.createCloseAccountInstruction(d.TOKEN_PROGRAM_ID,S,T,T,[])),e.prev=18,"market"!==v){e.next=27;break}if(b){e.next=22;break}throw"Slippage not set";case 22:return e.next=24,O.methods.createDecreasePositionMarketRequest({collateralUsdDelta:a,sizeUsdDelta:x,priceSlippage:b,jupiterMinimumOut:y,counter:E,entirePosition:P}).accounts({owner:T,receivingAccount:S,perpetuals:p.TJ,pool:p.FW,position:i.publicKey,positionRequest:_,positionRequestAta:D,custody:i.custody.publicKey,collateralCustody:i.collateralCustody.publicKey,desiredMint:m,tokenProgram:d.TOKEN_PROGRAM_ID,associatedTokenProgram:d.ASSOCIATED_TOKEN_PROGRAM_ID,systemProgram:u.SystemProgram.programId,referral:null}).instruction();case 24:K=e.sent,e.next=30;break;case 27:return e.next=29,O.methods.createDecreasePositionRequest({collateralUsdDelta:a,sizeUsdDelta:x,requestType:{trigger:{}},priceSlippage:b,jupiterMinimumOut:y,triggerPrice:k,triggerAboveThreshold:w,counter:E,entirePosition:P}).accounts({owner:T,receivingAccount:S,perpetuals:p.TJ,pool:p.FW,position:i.publicKey,positionRequest:_,positionRequestAta:D,custody:i.custody.publicKey,custodyOracleAccount:i.custody.account.oracle.oracleAccount,collateralCustody:i.collateralCustody.publicKey,desiredMint:m,tokenProgram:d.TOKEN_PROGRAM_ID,associatedTokenProgram:d.ASSOCIATED_TOKEN_PROGRAM_ID,systemProgram:u.SystemProgram.programId,referral:null}).instruction();case 29:K=e.sent;case 30:return e.abrupt("return",{instructions:[].concat(R,[K],B),positionRequestKey:_});case 33:throw e.prev=33,e.t0=e.catch(18),console.log(e.t0),e.t0;case 37:case"end":return e.stop()}}),e,null,[[18,33]])})))).apply(this,arguments)}},8770:function(e,t,n){n.d(t,{h:function(){return a}});var r=n(57565),o=n(55540),i=n(21382),a=function(e,t){var n=new r.Y7(t,e,{commitment:"processed",skipPreflight:!0});return new r.$r(o.x,i.KX,n)}},6901:function(e,t,n){n.d(t,{b:function(){return a},y:function(){return i}});var r=n(13838),o=n(39694),i=n.n(o)()((function(e){if(!e)return 4;var t=new r.Z(e);return t.gte(100)?2:t.gte(10)?3:4})),a=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:365,n=e.div(100).div(t).add(1).pow(t).sub(1).mul(100);return n}},33715:function(e,t,n){n.d(t,{l:function(){return r}});var r={isClosingAllPositions:(0,n(9364).cn)(!1)}},20787:function(e,t,n){n.d(t,{EA:function(){return h},Sv:function(){return v},vQ:function(){return r}});var r,o=n(63956),i=n(63945),a=n(9364),c=n(43355),s=n(49803),u=n(79989),l=n(44495),d=n(93981);function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}!function(e){e.ETH="Crypto.ETH/USD",e.BTC="Crypto.BTC/USD",e.SOL="Crypto.SOL/USD"}(r||(r={}));var f=(0,a.cn)({}),h=function(e){return(0,c.kv)(f,(function(t){return t[e]}),(function(e,t){return e==t}))},g=(0,a.cn)(null,(function(e,t,n){var r=e(f);r[n.id]={price:n.p,time:n.t},t(f,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?p(Object(n),!0).forEach((function(t){(0,o.Z)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):p(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},r))})),x=[{id:"0xef0d8b6fda2ceba41da15d4095d1da392a0d2f8ed0c6c7bc0f4cfac8c280b56d",name:"SOL",pythId:"Crypto.SOL/USD"},{id:"0xe62df6c8b4a85fe1a67db44dc12de5db330f7ac66b72dc658afedf0f4a415b43",name:"BTC",pythId:"Crypto.BTC/USD"},{id:"0xff61491a931112ddf1bd8147cd1b641375f79f5825126d665480874634fd0ace",name:"ETH",pythId:"Crypto.ETH/USD"}],m=x.map((function(e){return e.id})),v=function(e){var t=(0,u.Z)(),n=(0,d.useState)(0),r=n[0],o=n[1],a=(0,d.useRef)(Date.now());(0,d.useEffect)((function(){var e=setInterval((function(){a.current&&0!==a.current&&Date.now()-a.current>5e3&&(console.log("Stalled pyth websockets, restarting..."),o((function(e){return e+1})),a.current=Date.now())}),1e3);return function(){clearInterval(e)}}),[]),(0,l.Z)((function(){var n=new i.fj("https://jupiter.mainnet.pythnet.rpcpool.com",{priceFeedRequestConfig:{binary:!0}});return t.online&&e&&n.subscribePriceFeedUpdates(m,(function(e){var t=x.find((function(t){return t.id==="0x".concat(e.id)}));a.current=Date.now(),s.e.set(g,{id:null===t||void 0===t?void 0:t.pythId,p:Number(e.getPriceUnchecked().price||0)/Math.pow(10,8),t:e.getPriceUnchecked().publishTime})})),function(){n&&n.closeWebSocket()}}),[t.online,e,r])}}}]);
//# sourceMappingURL=5288-eee8848755e17ee5.js.map