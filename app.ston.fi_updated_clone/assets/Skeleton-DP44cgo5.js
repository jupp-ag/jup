import{aW as Y,aX as E,aY as Z,aZ as Q,a_ as F,a$ as G,b0 as X,b1 as J,b2 as L,au as tt,b3 as et,a3 as O,Z as B,H as st,ah as it,W as rt,A as V,ao as at,I as U,b4 as nt,j as z,f as ot}from"./index-rYEy9Y7-.js";import{H as ht,F as ut,m as C,o as _,h as w,j as y,k as W,i as dt,E as N,r as R,D as lt,R as ct}from"./vendors-Dtot3KuJ.js";var pt=class extends Y{constructor(e,t){super(),this.options=t,this.#s=e,this.#i=null,this.bindMethods(),this.setOptions(t)}#s;#t=void 0;#p=void 0;#e=void 0;#a;#u;#i;#f;#d;#l;#n;#o;#r;#c=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#t.addObserver(this),P(this.#t,this.options)?this.#h():this.updateResult(),this.#m())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return T(this.#t,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return T(this.#t,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#g(),this.#S(),this.#t.removeObserver(this)}setOptions(e,t){const s=this.options,i=this.#t;if(this.options=this.#s.defaultQueryOptions(e),E(s,this.options)||this.#s.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#t,observer:this}),typeof this.options.enabled<"u"&&typeof this.options.enabled!="boolean")throw new Error("Expected enabled to be a boolean");this.options.queryKey||(this.options.queryKey=s.queryKey),this.#b();const n=this.hasListeners();n&&k(this.#t,i,this.options,s)&&this.#h(),this.updateResult(t),n&&(this.#t!==i||this.options.enabled!==s.enabled||this.options.staleTime!==s.staleTime)&&this.#y();const r=this.#A();n&&(this.#t!==i||this.options.enabled!==s.enabled||r!==this.#r)&&this.#_(r)}getOptimisticResult(e){const t=this.#s.getQueryCache().build(this.#s,e),s=this.createResult(t,e);return yt(this,s)&&(this.#e=s,this.#u=this.options,this.#a=this.#t.state),s}getCurrentResult(){return this.#e}trackResult(e){const t={};return Object.keys(e).forEach(s=>{Object.defineProperty(t,s,{configurable:!1,enumerable:!0,get:()=>(this.#c.add(s),e[s])})}),t}getCurrentQuery(){return this.#t}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const t=this.#s.defaultQueryOptions(e),s=this.#s.getQueryCache().build(this.#s,t);return s.isFetchingOptimistic=!0,s.fetch().then(()=>this.createResult(s,t))}fetch(e){return this.#h({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#e))}#h(e){this.#b();let t=this.#t.fetch(this.options,e);return e?.throwOnError||(t=t.catch(Z)),t}#y(){if(this.#g(),Q||this.#e.isStale||!F(this.options.staleTime))return;const t=G(this.#e.dataUpdatedAt,this.options.staleTime)+1;this.#n=setTimeout(()=>{this.#e.isStale||this.updateResult()},t)}#A(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.#t):this.options.refetchInterval)??!1}#_(e){this.#S(),this.#r=e,!(Q||this.options.enabled===!1||!F(this.#r)||this.#r===0)&&(this.#o=setInterval(()=>{(this.options.refetchIntervalInBackground||X.isFocused())&&this.#h()},this.#r))}#m(){this.#y(),this.#_(this.#A())}#g(){this.#n&&(clearTimeout(this.#n),this.#n=void 0)}#S(){this.#o&&(clearInterval(this.#o),this.#o=void 0)}createResult(e,t){const s=this.#t,i=this.options,n=this.#e,r=this.#a,o=this.#u,l=e!==s?e.state:this.#p,{state:a}=e;let{error:m,errorUpdatedAt:M,fetchStatus:A,status:p}=a,D=!1,d;if(t._optimisticResults){const h=this.hasListeners(),v=!h&&P(e,t),$=h&&k(e,s,t,i);(v||$)&&(A=J(e.options.networkMode)?"fetching":"paused",a.dataUpdatedAt||(p="pending")),t._optimisticResults==="isRestoring"&&(A="idle")}if(t.select&&typeof a.data<"u")if(n&&a.data===r?.data&&t.select===this.#f)d=this.#d;else try{this.#f=t.select,d=t.select(a.data),d=L(n?.data,d,t),this.#d=d,this.#i=null}catch(h){this.#i=h}else d=a.data;if(typeof t.placeholderData<"u"&&typeof d>"u"&&p==="pending"){let h;if(n?.isPlaceholderData&&t.placeholderData===o?.placeholderData)h=n.data;else if(h=typeof t.placeholderData=="function"?t.placeholderData(this.#l?.state.data,this.#l):t.placeholderData,t.select&&typeof h<"u")try{h=t.select(h),this.#i=null}catch(v){this.#i=v}typeof h<"u"&&(p="success",d=L(n?.data,h,t),D=!0)}this.#i&&(m=this.#i,d=this.#d,M=Date.now(),p="error");const g=A==="fetching",S=p==="pending",b=p==="error",I=S&&g;return{status:p,fetchStatus:A,isPending:S,isSuccess:p==="success",isError:b,isInitialLoading:I,isLoading:I,data:d,dataUpdatedAt:a.dataUpdatedAt,error:m,errorUpdatedAt:M,failureCount:a.fetchFailureCount,failureReason:a.fetchFailureReason,errorUpdateCount:a.errorUpdateCount,isFetched:a.dataUpdateCount>0||a.errorUpdateCount>0,isFetchedAfterMount:a.dataUpdateCount>l.dataUpdateCount||a.errorUpdateCount>l.errorUpdateCount,isFetching:g,isRefetching:g&&!S,isLoadingError:b&&a.dataUpdatedAt===0,isPaused:A==="paused",isPlaceholderData:D,isRefetchError:b&&a.dataUpdatedAt!==0,isStale:q(e,t),refetch:this.refetch}}updateResult(e){const t=this.#e,s=this.createResult(this.#t,this.options);if(this.#a=this.#t.state,this.#u=this.options,this.#a.data!==void 0&&(this.#l=this.#t),E(s,t))return;this.#e=s;const i={},n=()=>{if(!t)return!0;const{notifyOnChangeProps:r}=this.options,o=typeof r=="function"?r():r;if(o==="all"||!o&&!this.#c.size)return!0;const u=new Set(o??this.#c);return this.options.throwOnError&&u.add("error"),Object.keys(this.#e).some(l=>{const a=l;return this.#e[a]!==t[a]&&u.has(a)})};e?.listeners!==!1&&n()&&(i.listeners=!0),this.#v({...i,...e})}#b(){const e=this.#s.getQueryCache().build(this.#s,this.options);if(e===this.#t)return;const t=this.#t;this.#t=e,this.#p=e.state,this.hasListeners()&&(t?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#m()}#v(e){tt.batch(()=>{e.listeners&&this.listeners.forEach(t=>{t(this.#e)}),this.#s.getQueryCache().notify({query:this.#t,type:"observerResultsUpdated"})})}};function ft(e,t){return t.enabled!==!1&&!e.state.dataUpdatedAt&&!(e.state.status==="error"&&t.retryOnMount===!1)}function P(e,t){return ft(e,t)||e.state.dataUpdatedAt>0&&T(e,t,t.refetchOnMount)}function T(e,t,s){if(t.enabled!==!1){const i=typeof s=="function"?s(e):s;return i==="always"||i!==!1&&q(e,t)}return!1}function k(e,t,s,i){return s.enabled!==!1&&(e!==t||i.enabled===!1)&&(!s.suspense||e.state.status!=="error")&&q(e,s)}function q(e,t){return e.isStaleByTime(t.staleTime)}function yt(e,t){return!E(e.getCurrentResult(),t)}class H{query;queryClient;constructor(t,s=et){this.queryClient=s,this.query=new At(this.queryClient,t),C(this,{query:_.ref}),this.query}get state(){return this.query.state}async refetch(){return this.query.refetch()}updateData(t){this.query.queryClient.setQueryData(this.query.queryOptions.queryKey??[],t)}}class x extends H{constructor(t,s){super(t,s),this.query.setupDisposables()}dispose(){this.query.dispose()}}class qt extends H{constructor(t,s){super(t,s),ht(this,"query",()=>{this.query.setupDisposables()}),ut(this,"query",()=>{this.query.dispose()})}}class At{queryClient;_queryOptions;qObserver;state;disposables=[];constructor(t,s){C(this,{state:_.ref,update:w,queryOptions:y,refetch:w,_updateOptions:w.bound}),this.queryClient=t,this._queryOptions=s}get queryOptions(){return this._queryOptions()}setupDisposables(){this.qObserver=new pt(this.queryClient,this.queryOptions),this.state=this.qObserver.getCurrentResult(),this.disposables.push(this.qObserver.subscribe(t=>{this.update(t)}),W(()=>this.queryOptions,this._updateOptions),()=>{this.qObserver.destroy()})}refetch(){return this.qObserver.refetch()}update(t){this.state=t}updateOptions(t){this._queryOptions=t}_updateOptions(){this.qObserver.setOptions(this.queryOptions)}dispose(){this.disposables.forEach(t=>t())}cancel(){this.queryClient.cancelQueries({queryKey:this.queryOptions.queryKey})}}function _t(e,t){const s=new Map([...e.entries()].filter(([r])=>!t.has(r))),i=new Map([...t.entries()].filter(([r])=>!e.has(r))),n=new Map([...t.entries()].filter(([r,o])=>{if(i.has(r)||s.has(r))return!1;const u=e.get(r);return u&&!dt.structural(u,o)}));return{removed:[...s.values()],updated:[...n.values()],added:[...i.values()]}}var mt=Object.defineProperty,gt=Object.getOwnPropertyDescriptor,f=(e,t,s,i)=>{for(var n=i>1?void 0:i?gt(t,s):t,r=e.length-1,o;r>=0;r--)(o=e[r])&&(n=(i?o(t,s,n):o(n))||n);return i&&n&&mt(t,s,n),n};let c=class{constructor(t){this.dependencies=t,this._logger=t.logger;const{AppSettingsStore:s,WalletStore:i,AssetsService:n}=t;this._assetsQuery=new x(()=>({queryKey:["AssetsStore._assetsQuery",`wallet-${i.wallet?.key}`],enabled:i.wallet!==void 0,initialData:n.getCachedAssetsMetadata().map(n.sanitizeAssetMetadata),queryFn:async()=>{const r=await n.fetchAssetsMetadata({walletAddress:i.wallet?.address,loadNonLiquid:s.showNonLiquidAssets,loadCommunity:s.showCommunityAssets,loadDeprecated:s.showDeprecatedAssets});if(r instanceof Error)throw r;return r},select:r=>(N(()=>{const{removed:o,updated:u,added:l}=_t(this._assetsMetadataMap,new Map(r.map(a=>[a.contract_address,a])));[...l,...u].forEach(a=>this._setAssetData(a)),o.forEach(a=>this._deleteAssetData(a))}),r),refetchOnMount:!0,refetchOnWindowFocus:!1,refetchInterval:t.ASSETS_REFETCH_INTERVAL_MS})),this._assetsBalancesQuery=new x(()=>({queryKey:["AssetsStore._assetsBalancesQuery",`wallet-${i.wallet?.key}`],enabled:!!i.wallet&&!!this._assetsQuery.state.isFetched,queryFn:async()=>{const r=i.wallet?.address;if(!r)return{};const o=await n.fetchAssetsBalances({walletAddress:r});if(o instanceof Error)throw o;return o},select:r=>(N(()=>{Object.entries(r).forEach(([o,u])=>{const l=this._assetsMetadataMap.get(o);l!==void 0&&l.balance!==u&&this._patchAssetData({contract_address:o,balance:u})})}),r),refetchInterval:t.ASSETS_BALANCES_REFETCH_INTERVAL_MS})),C(this,void 0,{name:"AssetsStore"}),W(()=>[t.AppSettingsStore.showCommunityAssets,t.AppSettingsStore.showDeprecatedAssets,t.AppSettingsStore.showNonLiquidAssets],()=>this._assetsQuery.refetch(),{name:"On AppSettingsStore assets flags change"})}_logger;_assetsQuery;_assetsBalancesQuery;_assetsMetadataMap=_.map([],{deep:!1});_normalizedSymbolIndex=new Map;_tonAssetAddress=null;_wtonAssetAddress=null;get allAssets(){const t=[...this._assetsMetadataMap.values()].map(s=>this.dependencies.AssetsService.buildAssetEntity(s)).filter(Boolean);return t.length?t:void 0}get assets(){return this.allAssets?this.allAssets.filter(t=>this._filterAssets(t)):this.allAssets}get isInitialized(){return this.allAssets!==void 0}get isBalancesLoaded(){return this.dependencies.WalletStore.wallet?this._assetsQuery.state.isFetched:!0}get _tonAsset(){if(this._tonAssetAddress){const t=this._getAssetByAddress(this._tonAssetAddress);if(t)return t}return this._logger.child("tonAsset").info("tonAsset is not found in assets, using default"),this.dependencies.TON_ASSET}get _wtonAsset(){return this._wtonAssetAddress?this._getAssetByAddress(this._wtonAssetAddress):null}getTonAsset=()=>this._tonAsset;getWtonAsset=()=>this._wtonAsset;getAsset=t=>t instanceof O?this.getAssetByAddress(t):typeof t=="string"&&O.isValid(t)?this.getAssetByAddress(new O(t)):typeof t=="string"?this.getAssetBySymbol(t):null;getAssetByAddress=t=>this._getAssetByAddress(t.key);_getAssetByAddress(t){const s=this._assetsMetadataMap.get(t);return s?this.dependencies.AssetsService.buildAssetEntity(s):null}getAssetBySymbol=t=>{const s=this._normalizedSymbolIndex.get(this._normalizeSymbol(t));return s?this._getAssetByAddress(s):null};fetchAssets=async()=>(await this._assetsQuery.refetch(),this.assets);importAssetMetadata=t=>{this.dependencies.AssetsService.mutateAssetsMetadata([{...t,isImported:!0}]),this._assetsQuery.updateData(this.dependencies.AssetsService.getCachedAssetsMetadata())};toggleFavoriteAsset=t=>{const s=this._assetsMetadataMap.get(t.contractAddress.key);s&&(this.dependencies.AssetsService.mutateAssetsMetadata([{...s,isFavorite:!s.isFavorite}]),this._assetsQuery.updateData(this.dependencies.AssetsService.getCachedAssetsMetadata()))};_filterAssets(t){const{dependencies:{AppSettingsStore:{showDeprecatedAssets:s,showCommunityAssets:i}}}=this;return t.isBlacklisted?!1:t.isDeprecated?s||t.amount.gtn(0):t.isCommunity?i||t.isImported||t.amount.gtn(0):!0}_normalizeSymbol(t){return t.toUpperCase()}_setAssetData=t=>{this._assetsMetadataMap.set(t.contract_address,t);const s=t.kind;s===B.TON?this._tonAssetAddress=t.contract_address:s===B.WTON&&(this._wtonAssetAddress=t.contract_address),t.default_symbol&&this._normalizedSymbolIndex.set(this._normalizeSymbol(t.symbol),t.contract_address)};_patchAssetData=t=>{const s=this._assetsMetadataMap.get(t.contract_address);s&&this._setAssetData({...s,...t})};_deleteAssetData=t=>{this._assetsMetadataMap.delete(t.contract_address)}};f([_],c.prototype,"_tonAssetAddress",2);f([_],c.prototype,"_wtonAssetAddress",2);f([y],c.prototype,"allAssets",1);f([y],c.prototype,"assets",1);f([y],c.prototype,"isInitialized",1);f([y],c.prototype,"isBalancesLoaded",1);f([y],c.prototype,"_tonAsset",1);f([y],c.prototype,"_wtonAsset",1);const Dt=new c({logger:st.child("stores","AssetsStore"),AssetsService:it,WalletStore:rt,AppSettingsStore:V,TON_ASSET:at,ASSETS_REFETCH_INTERVAL_MS:U.APP_ASSETS_REFETCH_INTERVAL_MS,ASSETS_BALANCES_REFETCH_INTERVAL_MS:U.APP_ASSETS_BALANCE_REFETCH_INTERVAL_MS}),K="(prefers-color-scheme: dark)",j=()=>window.matchMedia(K).matches?"dark":"light";function St(){const[e,t]=R.useState(j());return R.useEffect(()=>{const s=()=>t(j()),i=window.matchMedia(K);return i.addEventListener("change",s),()=>i.removeEventListener("change",s)},[]),e}function bt(){const e=St(),t=lt(()=>V.theme);return R.useMemo(()=>t===nt.SYSTEM?e:t,[t,e])}const vt="light",Ot=ct.forwardRef(({src:e,...t},s)=>{const i=bt();return z.jsx("img",{...t,ref:s,src:e[i]??e[vt]})});Ot.displayName="ThemeableImg";const wt="_skeleton_q0cm5_1",Et={skeleton:wt},It=({...e})=>z.jsx("div",{...e,className:ot(Et.skeleton,e.className)});export{Dt as A,x as M,pt as Q,It as S,Ot as T,qt as a,_t as g,bt as u};
